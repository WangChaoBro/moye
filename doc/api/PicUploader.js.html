<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: PicUploader.js</title>
    
    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">
    
    <h1 class="page-title">Source: PicUploader.js</h1>
    
    


    
    <section>
        <article>
            <pre class="prettyprint source"><code>/**
 * Moye (Zhixin UI)
 * Copyright 2014 Baidu Inc. All rights reserved.
 *
 * @file 图片上传预览组件
 * @author mengke(mengke01@baidu.com)
 */


define(function (require) {

    var lib = require('./lib');
    var Control = require('./Control');

    /**
     * 检查浏览器是否支持FileReader
     *
     * @type {boolean}
     */
    var supportFileReader = 'FileReader' in window;


    /**
     * 获取本地图片数据
     *
     * @param {string} filePath 文件名
     * @param {Function=} callBack 回调函数，返回图片的base64编码
     */

    function getLocalImageData(filePath, callBack) {
        var reader = new FileReader(filePath);
        reader.onload = function (e) {
            callBack && callBack(e.target.result);
            reader = null;
        };
        reader.readAsDataURL(filePath);
    }

    /**
     * 创建一个file节点
     *
     * @param {Object} options 选项设置
     * @param {string} options.className 类名
     *
     * @return {HTMLElement} dom节点
     * @inner
     */

    function createFileNode(options) {
        var node = document.createElement('input');
        node.type = 'file';
        for (var i in options) {
            node[i] = options[i];
        }
        return node;
    }

    /**
     * 私有函数或方法
     * 
     * @type {Object}
     * @namespace
     * @name module:PicUploader~privates
     */
    var privates = /** @lends module:PicUploader~privates */ {


        /**
         * 根据名字构建的css class名称
         *
         * @param {string} name 模块名字
         * @return {string} 构建的class名称
         * @private
         */
        getClass: function (name) {
            name = name ? '-' + name : '';
            return this.options.prefix + name;
        },

        /**
         * 获得指定dialog模块的dom元素
         *
         * @param {string} name 模块名字
         * @param {string} scope 查找范围
         * @return {HTMLElement} 模块的DOM元素
         * @private
         */
        getDom: function (name, scope) {
            return lib.q(
            privates.getClass.call(this, name), lib.g(scope))[0];
        },

        /**
         * 当点击关闭的时候
         *
         * @private
         * @param {HTMLEvent} e dom事件对象
         */
        onCloseClick: function (e) {
            var target = lib.getTarget(e);
            var picker = lib.getAncestorByClass(
            target, privates.getClass.call(this, 'picker'));
            privates.removePicker.call(this, picker);
        },

        /**
         * 当文件选择改变的时候处理函数
         *
         * @private
         * @param {HTMLEvent} e dom事件对象
         * @fires module:PicUploader#pickerror
         * @fires module:PicUploader#pick
         */
        onFileChange: function (e) {

            var target = lib.getTarget(e);
            var filePath = target.value;

            if (!filePath) {
                return;
            }

            var fileName = filePath.slice(
            Math.max(
            filePath.lastIndexOf('/'), filePath.lastIndexOf('\\')) + 1);
            fileName = fileName.slice(0, fileName.lastIndexOf('.'));

            var picker = lib.getAncestorByClass(
            target, privates.getClass.call(this, 'picker'));

            var bound = this._bound;

            if (!filePath.match(this.options.fileType)) {

                //IE浏览器不允许设置file.value这里移除之后再创建一个
                if (lib.browser.ie) {
                    //这里用cloneNode会出现一堆诡异的问题
                    // 只能创建新的节点来替换，会损失一部分原始的信息
                    // 
                    var newTarget = createFileNode({
                        className: target.className
                    });

                    target.parentNode.insertBefore(newTarget, target);

                    //删除事件
                    lib.un(target, 'change', bound.onFileChange);
                    target.parentNode.removeChild(target);

                    //重新绑定事件
                    lib.on(newTarget, 'change', bound.onFileChange);

                }
                else {
                    target.value = '';
                }

                lib.addClass(picker, privates.getClass.call(this, 'error'));

                /**
                 * @event module:PicUploader#error
                 * @property {Object} event 事件源对象
                 * event.fileName {string} 被移除的文件名
                 */
                this.fire('pickerror', {
                    fileName: filePath

                });
            }
            else {

                var pic = privates.getDom.call(this, 'pic', picker);

                //支持fileReader则可以提供预览
                if (supportFileReader) {
                    getLocalImageData(target.files[0], function (data) {
                        var img = document.createElement('IMG');
                        img.src = data;
                        pic.appendChild(img);
                        pic = null;
                    });
                }
                //否则只显示文件名字
                else {
                    pic.innerHTML = '&lt;em>' + fileName + '&lt;/em>';
                }

                picker.title = fileName;
                privates.getDom.call(this, 'title', picker).innerHTML = fileName;

                //修改class
                lib.removeClass(picker, privates.getClass.call(this, 'cur'));
                lib.removeClass(picker, privates.getClass.call(this, 'error'));
                lib.addClass(picker, privates.getClass.call(this, 'picked'));

                //解绑事件
                lib.un(target, 'change', bound.onFileChange);

                this.count++;
                //如果没有超过限制，则继续生成一个上传框
                if (this.count &lt; this.options.maxCount) {
                    privates.create.call(this);
                }

                /**
                 * @event module:PicUploader#error
                 * @param {Object} e 选择文件事件
                 * @param {string} e.fileName 被移除的文件名
                 */
                this.fire('pick', {
                    fileName: filePath
                });

            }
        },

        /**
         * 移出一个已选择的图片框
         *
         * @private
         * @param {string|HTMLElement} id 选择框元素
         * @fires module:PicUploader#remove
         */
        removePicker: function (id) {
            var picker = lib.g(id);
            var fileName = privates.getDom.call(this, 'file', picker).value;
            var bound = this._bound;

            //解绑事件
            lib.un(
            privates.getDom.call(this, 'file', picker), 'change', bound.onFileChange);

            lib.un(
            privates.getDom.call(this, 'close', picker), 'click', bound.onCloseClick);

            picker.parentNode.removeChild(picker);

            this.count--;

            //如果当前个数小于最大个数减1，则生成一个选择框
            if (this.count === this.options.maxCount - 1) {
                privates.create.call(this);
            }

            /**
             * @event module:PicUploader#remove
             * @param {Object} e 事件源对象
             * @param {string} e.fileName 被移除的文件名
             */
            this.fire('remove', {
                fileName: fileName
            });
        },

        /**
         * 绑定图片选择
         *
         * @private
         * @param {(string|HTMLElement)} id 当前的picker对象
         */
        bindPicker: function (id) {
            var bound = this._bound;
            //绑定文件选择
            lib.on(privates.getDom.call(this, 'file', id), 'change', bound.onFileChange);

            //绑定关闭
            lib.on(privates.getDom.call(this, 'close', id), 'click', bound.onCloseClick);
        },

        /**
         * 创建一个上传框
         * @private
         */
        create: function () {
            var cls = {
                closeClass: privates.getClass.call(this, 'close'),
                picClass: privates.getClass.call(this, 'pic'),
                titleClass: privates.getClass.call(this, 'title'),
                fileClass: privates.getClass.call(this, 'file'),
                wrapperClass: privates.getClass.call(this, 'wrapper')
            };

            //渲染主框架内容
            var picker = this.createElement('div', {
                'className': privates.getClass.call(this, 'picker') 
                        + ' ' 
                        + privates.getClass.call(this, 'cur')
            });

            this.options.main.appendChild(picker);

            picker.innerHTML = this.options.tpl.replace(
                /#\{([\w-.]+)\}/g,
                function ($0, $1) {
                    return cls[$1] || '';
                }
            );

            privates.bindPicker.call(this, this.curPicker = picker);
        }

    };

    /**
     * 对话框
     *
     * @extends module:Control
     * @requires lib
     * @requires Control
     * @exports PicUploader
     * @example
     *
     * var uploader = new PicUploader({
     *    main: lib.g('uploader-container'),
     *    maxCount: 3,
     *    fileType: /\.(jpg|png|gif|jpeg)$/
     * });
     *
     */
    var PicUploader = Control.extend(/** @lends module:PicUploader.prototype */{

        /**
         * 控件类型标识
         *
         * @type {string}
         * @override
         * @private
         */
        type: 'PicUploader',

        /**
         * 控件配置项
         *
         * @name module:Dialog#options
         * @type {Object}
         * @property {(string | HTMLElement)} options.main 控件渲染容器
         * @property {string} options.prefix class默认前缀
         * @property {int} options.maxCount 最多选择的图片个数
         * @property {Regexp} options.fileType 图片类型正则
         * @property {string} options.tpl 使用的模板
         *
         * @private
         */
        options: {

            // 控件渲染主容器
            main: '',

            // 控件class前缀，同时将作为main的class之一
            prefix: 'ecl-ui-picuploader',

            //最多选择图片的个数
            maxCount: 3,

            //支持上传的文件类型
            fileType: /\.(jpg|png|gif|jpeg)$/,

            //模板框架
            tpl: ''
                +   '&lt;div class="#{closeClass}" title="关闭">×&lt;/div>'
                +   '&lt;div class="#{picClass}">&lt;/div>'
                +   '&lt;div class="#{titleClass}">点击上传&lt;/div>'
                +   '&lt;a href="javascript:;" class="#{wrapperClass}">'
                +       '&lt;input type="file" class="#{fileClass}">'
                +   '&lt;/a>'
        },


        /**
         * 当前已经选择的图片框个数
         *
         * @type {number}
         * @private
         */
        count: 0,

        /**
         * 控件初始化
         *
         * @param {Object} options 控件配置项
         * @see module:Control#options
         * @private
         */
        init: function (options) {
            if (!options.main && 1 !== options.main.nodeType) {
                throw new Error('invalid main');
            }

            this.bindEvents(privates);

            this._disabled = options.disabled;

            if (this._disabled) {
                this.disable();
            }
        },


        /**
         * 绘制控件
         *
         * @override
         * @public
         */
        render: function () {
            if (!this.rendered) {
                privates.create.call(this);
                this.rendered = true;
            }

            return this;
        },

        /**
         * 根据文件路径移除图片框
         *
         * @param {string} filePath 文件路径
         * @return {module:PicUploader} 本对象
         * @publick
         */
        remove: function (filePath, checker) {
            var me = this;
            checker = checker ||
            function (removePath, filePath, index) {
                index;
                return removePath === filePath;
            };
            lib.each(
                lib.q(privates.getClass.call(this, 'file'),
                this.options.main),
                function (item, index) {
                    if (item.value === filePath) {
                        if (checker(item.value, filePath, index)) {
                            privates.removePicker.call(
                                me,
                                lib.getAncestorByClass(item, privates.getClass.call(me, 'picker'))
                            );
                        }
                    }
                }
            );
            return this;
        },


        /**
         * 根据索引移除图片框
         *
         * @param {number} index 索引
         * @return {module:PicUploader} 本对象
         * @public
         */
        removeAt: function (index) {
            var list = lib.q(privates.getClass.call(this, 'picker'), this.options.main);
            if (list[index].id !== this.curPicker) {
                privates.removePicker.call(this, list[index]);
            }
            return this;
        },

        /**
         * 获得已经选择的文件列表
         *
         * @return {Array.&lt;string>} 文件名字列表
         * @public
         */
        getFileList: function () {
            var me = this;
            var files = [];
            lib.each(
                lib.q(privates.getClass.call(this, 'file'), this.options.main),
                function (item) {
                    if (item.value.match(me.options.fileType)) {
                        files.push(item.value);
                    }
                }
            );
            return files;
        },

        /**
         * 启用组件
         *
         * @return {module:PicUploader} 本对象
         * @override
         */
        enable: function () {

            if (this.curPicker) {
                lib.removeClass(this.options.main, privates.getClass.call(this, 'disabled'));
            }

            this._disabled = 0;

            return this;
        },

        /**
         * 禁用组件
         *
         * @return {module:PicUploader} 本对象
         * @override
         */
        disable: function () {

            if (this.curPicker) {
                lib.addClass(this.options.main, privates.getClass.call(this, 'disabled'));
            }

            this._disabled = 1;

            return this;
        },

        /**
         * 销毁，注销事件，解除引用
         *
         * @public
         * @fires module:PicUploader#dispose
         * @override
         */
        dispose: function () {

            if (this.curPicker) {
                var bound = this._bound;

                lib.un(
                    privates.getDom.call(this, 'file', this.curPicker),
                    'change',
                    bound.onFileChange
                );

                lib.un(
                    privates.getDom.call(this, 'close', this.curPicker),
                    'click',
                    bound.onCloseClick
                );
                this.curPicker = 0;
            }

            this.options.main.innerHTML = '';

            this.parent('dispose');
        }
    });

    return PicUploader;
});</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Index</a></h2><h3>Modules</h3><ul><li><a href="module-Calendar.html">Calendar</a></li><li><a href="module-CalendarExtension.html">CalendarExtension</a></li><li><a href="module-City.html">City</a></li><li><a href="module-Control.html">Control</a></li><li><a href="module-Cookie.html">Cookie</a></li><li><a href="module-Dialog.html">Dialog</a></li><li><a href="module-DialogFactory.html">DialogFactory</a></li><li><a href="module-Filter.html">Filter</a></li><li><a href="module-FloatTip.html">FloatTip</a></li><li><a href="module-Lazy.html">Lazy</a></li><li><a href="module-LazyImg.html">LazyImg</a></li><li><a href="module-lib.html">lib</a></li><li><a href="module-log.html">log</a></li><li><a href="module-Lunar.html">Lunar</a></li><li><a href="module-Mask.html">Mask</a></li><li><a href="module-Pager.html">Pager</a></li><li><a href="module-PicUploader.html">PicUploader</a></li><li><a href="module-Popup.html">Popup</a></li><li><a href="module-Rating.html">Rating</a></li><li><a href="module-ScrollBar.html">ScrollBar</a></li><li><a href="module-Select.html">Select</a></li><li><a href="module-Slider.html">Slider</a></li><li><a href="module-SliderAnim.html">SliderAnim</a></li><li><a href="module-Tabs.html">Tabs</a></li><li><a href="module-Tip.html">Tip</a></li></ul><h3>Events</h3><ul><li><a href="CalendarExtension-Menu.html#event:beforeShow">beforeShow</a></li><li><a href="CalendarExtension-Menu.html#event:click">click</a></li><li><a href="CalendarExtension-Menu.html#event:pick">pick</a></li><li><a href="module-Calendar.html#event:beforeShow">beforeShow</a></li><li><a href="module-Calendar.html#event:hide">hide</a></li><li><a href="module-Calendar.html#event:pick">pick</a></li><li><a href="module-Calendar.html#event:show">show</a></li><li><a href="module-City.html#event:beforeShow">beforeShow</a></li><li><a href="module-City.html#event:click">click</a></li><li><a href="module-City.html#event:hide">hide</a></li><li><a href="module-City.html#event:pick">pick</a></li><li><a href="module-City.html#event:show">show</a></li><li><a href="module-Control.html#event:disable">disable</a></li><li><a href="module-Control.html#event:dispose">dispose</a></li><li><a href="module-Control.html#event:enable">enable</a></li><li><a href="module-Dialog.html#event:beforedispose">beforedispose</a></li><li><a href="module-Dialog.html#event:beforehide">beforehide</a></li><li><a href="module-Dialog.html#event:beforeshow">beforeshow</a></li><li><a href="module-Dialog.html#event:cancel">cancel</a></li><li><a href="module-Dialog.html#event:confirm">confirm</a></li><li><a href="module-Dialog.html#event:dispose">dispose</a></li><li><a href="module-Dialog.html#event:hide">hide</a></li><li><a href="module-Dialog.html#event:show">show</a></li><li><a href="module-Filter.html#event:change">change</a></li><li><a href="module-Filter.html#event:click">click</a></li><li><a href="module-log.html#event:click">click</a></li><li><a href="module-log.html#event:send">send</a></li><li><a href="module-log.html#event:start">start</a></li><li><a href="module-Lunar.html#event:click">click</a></li><li><a href="module-Lunar.html#event:navigate">navigate</a></li><li><a href="module-Lunar.html#event:pick">pick</a></li><li><a href="module-Pager.html#event:change">change</a></li><li><a href="module-Pager.html#event:click">click</a></li><li><a href="module-PicUploader.html#event:error">error</a></li><li><a href="module-PicUploader.html#event:remove">remove</a></li><li><a href="module-Popup.html#event:beforeShow">beforeShow</a></li><li><a href="module-Popup.html#event:click">click</a></li><li><a href="module-Popup.html#event:hide">hide</a></li><li><a href="module-Popup.html#event:show">show</a></li><li><a href="module-Rating.html#event:rated">rated</a></li><li><a href="module-ScrollBar.html#event:change">change</a></li><li><a href="module-Select.html#event:beforeShow">beforeShow</a></li><li><a href="module-Select.html#event:change">change</a></li><li><a href="module-Select.html#event:hide">hide</a></li><li><a href="module-Select.html#event:pick">pick</a></li><li><a href="module-Select.html#event:show">show</a></li><li><a href="module-Slider.html#event:change">change</a></li><li><a href="module-Tabs.html#event:change">change</a></li><li><a href="module-Tip.html#event:beforeShow">beforeShow</a></li><li><a href="module-Tip.html#event:click">click</a></li><li><a href="module-Tip.html#event:hide">hide</a></li><li><a href="module-Tip.html#event:show">show</a></li></ul><h3>Namespaces</h3><ul><li><a href="module-CalendarExtension-Menu-privates.html">privates</a></li><li><a href="module-CalendarExtension-privates.html">privates</a></li><li><a href="module-Calendar-privates.html">privates</a></li><li><a href="module-City-privates.html">privates</a></li><li><a href="module-Dialog-privates.html">privates</a></li><li><a href="module-Filter-privates.html">privates</a></li><li><a href="module-FloatTip-privates.html">privates</a></li><li><a href="module-LazyImg-privates.html">privates</a></li><li><a href="module-Lazy-privates.html">privates</a></li><li><a href="module-lib.array.html">array</a></li><li><a href="module-lib.browser.html">browser</a></li><li><a href="module-lib.configurable.html">configurable</a></li><li><a href="module-lib.date.html">date</a></li><li><a href="module-lib.dom.html">dom</a></li><li><a href="module-lib.event.html">event</a></li><li><a href="module-lib.fn.html">fn</a></li><li><a href="module-lib.object.html">object</a></li><li><a href="module-lib.observable.html">observable</a></li><li><a href="module-lib.page.html">page</a></li><li><a href="module-lib.string.html">string</a></li><li><a href="module-Lunar-privates.html">privates</a></li><li><a href="module-Pager-privates.html">privates</a></li><li><a href="module-PicUploader-privates.html">privates</a></li><li><a href="module-Popup-privates.html">privates</a></li><li><a href="module-Rating-privates.html">privates</a></li><li><a href="module-ScrollBar-privates.html">privates</a></li><li><a href="module-Select-privates.html">privates</a></li><li><a href="module-Slider-privates.html">privates</a></li><li><a href="module-Tabs-privates.html">privates</a></li><li><a href="module-Tip-privates.html">privates</a></li></ul>
</nav>

<br clear="both">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.2.2</a> on Mon May 26 2014 20:04:57 GMT+0800 (CST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
