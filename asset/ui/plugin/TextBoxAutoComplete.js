/*! 2015 Baidu Inc. All Rights Reserved */
define("ui/plugin/TextBoxAutoComplete",["require","jquery","../lib","./Plugin"],function(require){var t=require("jquery"),e=require("../lib"),n=require("./Plugin"),i=n.extend({$class:"TextBoxAutoComplete",initialize:function(n){this.$parent(n),this.load=e.delay(t.proxy(this.load,this),this.delay,this),this.current=null},activate:function(e){this.$parent(e),this.textbox=e;var n=e.id;t(e.input).on("keyup."+n,t.proxy(this._onKeyup,this)).get(0).autocomplete="off",e.getSuggestions=this.load,e.hideSuggestions=t.proxy(this.hide,this),e.on("input",t.proxy(this._onInput,this))},delay:200,datasource:function(){return null},_onInput:function(){var t=this.textbox.getValue();t?this.load(t):this.hide()},_onBlur:function(){this.hide()},_onKeyup:function(t){if(!t.isDefaultPrevented())switch(t.keyCode){case 40:return void this.next();case 38:return void this.prev();case 27:return void this.hide();default:var e=this.textbox.getValue();this.setCache(e)}},setCache:function(t){this._cache=t},getCache:function(){return this._cache||""},_onBodyClick:function(e){var n=e.target;if(this.main&&t.contains(this.main,n)){e.preventDefault();var i=this.textbox,r=i.helper.getPartClasses("autocomplete-item")[0];return n=t(e.target).closest("."+r),void this.select(n[0])}if(!t.contains(this.textbox.main,e.target))this.hide()},select:function(e){var n=this.suggestions;if(n){{var i=+t(e).data("index"),r=this.textbox,a=n[i];this.adapter.toInput(a)}r.fire("autocomplete",{suggestion:a,mode:"pick"}),r.input.focus(),this.hide()}},load:function(n){var i=this.datasource(n);if(i&&e.isFunction(i.then))i.then(t.proxy(this._onSuggestionLoaded,this));else this._onSuggestionLoaded(i);return this},_onSuggestionLoaded:function(t){if(!t||!t.length)this.hide();else this.show(t)},getMain:function(){var t=this.main;if(!t){var e=this.textbox;t=this.main=e.helper.createPart("autocomplete"),e.main.appendChild(t)}return t},show:function(e){this.suggestions=e||[];var n=this.count=e.length;if(!n)return this;var i=this.textbox,r=i.helper,a=t(this.getMain());this.current=null;for(var o=[],s=0;n>s;s++){var u=this.adapter.toList(e[s]),l='<a class="'+r.getPartClassName("autocomplete-item")+'" data-index="'+s+'" href="#">'+u+"</a>";o.push(l)}return a.html(o.join("")).show(),t(document.body).on("click."+i.id,t.proxy(this._onBodyClick,this)),this},adapter:{toList:function(t){return{text:t.text,value:t.value}},toInput:function(t){return t.value}},hide:function(){var e=new t.Event("autocompletebeforehide");if(this.textbox.fire(e),!e.isDefaultPrevented()){var n=this.main;if(n)t(n).hide(),t(document.body).off("click."+this.textbox.id);return this.suggestions=null,this.current=null,this.count=null,this._cache=null,this}},next:function(){this.move("down")},prev:function(){this.move("up")},move:function(e){var n=this.count||0;if(0!==n){var i,r=this.current;if("down"===e)i=null===r?0:r+1,i=i===n?null:i;else i=null===r?n-1:r-1,i=-1===i?null:i;var a=t(this.main).children();if(null!==r)a.eq(r).removeClass("hover");if(null!==i)a.eq(i).addClass("hover");var o=this.textbox,s=this.suggestions[i],u=new t.Event("autocomplete",{suggestion:s,mode:"move"});if(o.fire(u),!u.isDefaultPrevented())if(this.current=i,null===i)o.setValue(this.getCache());else o.setValue(this.adapter.toInput(s))}},inactivate:function(){var e=this.textbox;if(t(e.input).off("keyup"+e.id),this.main)t(main).off("click"),this.main=null;this.textbox=null}});return i});