/*! 2015 Baidu Inc. All Rights Reserved */
define("ui/Lunar",["require","jquery","./lib","./Control"],function(require){function e(e){var n=348+(m[e-1900]>>4).toString(2).replace(/0/g,"").length;return n+t(e)}function t(e){return n(e)?15===(15&m[e-1899])?30:29:0}function n(e){var t=15&m[e-1900];return 15===t?0:t}function i(e,t){return m[e-1900]&65536>>t?30:29}function r(e,t){var n=new Date(31556925974.7*(e-1900)+6e4*y[t]+Date.UTC(1900,0,6,2,5));return n.getUTCDate()+(b[e+""+t]||0)}function a(e){var t=e.getFullYear(),n=e.getMonth(),i=e.getDate(),a=i===r(t,2*n)?v[2*n]:i===r(t,2*n+1)?v[2*n+1]:"";return a?{type:"solar-term",text:a}:null}function o(e){if(11===e.month&&e.day>28){var t=new Date(e.solar.getTime()+864e5);if(t=c(t),1===t.day)e.month=0,e.day=0}var n=e.leap?"":x[h(e.month+1)+h(e.day)]||"";return n?{type:"lunar-festival",text:n}:null}function s(e){var t=w[h(e.getMonth()+1)+h(e.getDate())];return t?{type:"solar-festival",text:t}:null}function u(e){var t=e.getDay(),n=[h(e.getMonth()+1),t],i=e.getDate(),r=(7+t-(i-1))%7,a=new Date(e.getFullYear(),n[0],0),o=a.getDay(),s=a.getDate(),u=Math.ceil((i+r-1)/7)+(r>t?0:1),l=4+Math.floor((t+s-i)/7)+(t>o?0:1),c=C[n.join(u)]||C[n.join(l)];return c?{type:"solar-weak-festival",text:c}:null}function l(e,t){return o(t)||s(e)||u(e)||a(e)}function c(r){var a,o=0,s=0,u=(Date.UTC(r.getFullYear(),r.getMonth(),r.getDate())-Date.UTC(1900,0,31))/864e5;for(a=1900;2100>a&&u>0;a++)s=e(a),u-=s;if(0>u)u+=s,a--;var l=a;o=n(a);var c=!1;for(a=1;13>a&&u>0;a++){if(o>0&&a===o+1&&!c)--a,c=!0,s=t(l);else s=i(l,a);if(c&&a===o+1)c=!1;u-=s}if(0===u&&o>0&&a===o+1)if(c)c=!1;else c=!0,--a;if(0>u)u+=s,--a;return{year:l,month:a-1,day:u+1,leap:c,solar:r}}function f(e,t){var n,i=c(e),r=i.month,a=i.day,o=["初","十","廿","卅","卌"],s=["日","一","二","三","四","五","六","七","八","九","十"],u=["正","二","三","四","五","六","七","八","九","十","十一","腊"],f=l(e,i);if(!f){if(1===a)n=(i.leap?"闰":"")+u[r]+"月";else if(a%10>0)n=o[a/10|0]+s[a%10];else n=(a>10?s[a/10]:o[0])+s[10];f={type:"lunar",text:n}}return'<span class="'+t+"-"+f.type+'">'+f.text+"</span>"}function h(e){return(e>9?"":"0")+e}var d=require("jquery"),p=require("./lib"),g=require("./Control"),m=[19416,19168,42352,21717,53856,55632,21844,22191,39632,21970,19168,42422,42192,53840,53909,46415,54944,44450,38320,18807,18815,42160,46261,27216,27968,43860,11119,38256,21234,18800,25958,54432,59984,27285,23263,11104,34531,37615,51415,51551,54432,55462,46431,22176,42420,9695,37584,53938,43344,46423,27808,46416,21333,19887,42416,17779,21183,43432,59728,27296,44710,43856,19296,43748,42352,21088,62051,55632,23383,22176,38608,19925,19152,42192,54484,53840,54616,46400,46752,38310,38335,18864,43380,42160,45690,27216,27968,44870,43872,38256,19189,18800,25776,29859,59984,27480,23232,43872,38613,37600,51552,55636,54432,55888,30034,22176,43959,9680,37584,51893,43344,46240,47780,44368,21977,19360,42416,20854,21183,43312,31060,27296,44368,23378,19296,42726,42208,53856,60005,54576,23200,30371,38608,19195,19152,42192,53430,53855,54560,56645,46496,22224,21938,18864,42359,42160,43600,45653,27951,44448,19299,37759,18936,18800,25776,26790,59999,27424,42692,43759,37600,53987,51552,54615,54432,55888,23893,22176,42704,21972,21200,43448,43344,46240,46758,44368,21920,43940,42416,21168,45683,26928,29495,27296,44368,19285,19311,42352,21732,53856,59752,54560,55968,27302,22239,19168,43476,42192,53584,62034,54560],v=["小寒","大寒","立春","雨水","惊蛰","春分","清明","谷雨","立夏","小满","芒种","夏至","小暑","大暑","立秋","处暑","白露","秋分","寒露","霜降","立冬","小雪","大雪","冬至"],y=[0,21208,42467,63836,85337,107014,128867,150921,173149,195551,218072,240693,263343,285989,308563,331033,353350,375494,397447,419210,440795,462224,483532,504758],b={19762:1,19802:1,20092:1,20129:-1,201222:1,20132:1,201313:-1,201323:1,20144:1,20150:1,201622:1,201713:-1,201723:-1,20183:1,20185:1,20192:-1,201911:-1,202012:-1,202015:-1,202022:1},x={"0100":"除夕","0101":"春节","0115":"元宵节","0202":"龙抬头","0505":"端午节","0707":"七夕","0715":"中元节","0815":"中秋节","0909":"重阳节",1208:"腊八节",1223:"小年"},w={"0101":"元旦","0214":"情人节","0308":"妇女节","0312":"植树节","0401":"愚人节","0422":"地球日","0501":"劳动节","0504":"青年节","0531":"无烟日","0601":"儿童节","0606":"爱眼日","0701":"建党日","0707":"抗战纪念日","0801":"建军节","0910":"教师节","0918":"九·一八纪念日",1001:"国庆节",1031:"万圣节",1111:"光棍节",1201:"艾滋病日",1213:"南京大屠杀纪念日",1224:"平安夜",1225:"圣诞节"},C={"0150":"国际麻风节","0520":"母亲节","0630":"父亲节",1144:"感恩节"},T="yyyy-MM-dd",k={},N={getYYYYMM:function(e){return p.isString(e)?e:this.format(this.from(e),"yyyyMM")},build:function(e){e=new Date((e||this.date).getTime()),this.monthElement.innerHTML=N.buildMonth.call(this,e),N.updateStatus.call(this),N.updatePrevNextStatus.call(this,e),this.fire("navigate",{date:e,yyyyMM:N.getYYYYMM.call(this,e)})},updatePrevNextStatus:function(e){var t=this.options,n=t.prefix,i=this.range,r=d("."+n+"-pre",this.main),a=d("."+n+"-next",this.main);e=e||this.date||this.from(this.value);var o=N.getYYYYMM.call(this,e),s=!i||!i.begin||N.getYYYYMM.call(this,i.begin)<o?"show":"hide";r[s](),s=!i||!i.end||N.getYYYYMM.call(this,i.end)>o?"show":"hide",a[s]()},buildMonth:function(e){var t=e.getFullYear(),n=e.getMonth()+1,i=e.getDate(),r=e.getDay(),a=t+h(n);if(k[a])return k[a];var o=7,s="-",u=this.options,l=u.prefix,c=[];c.push("<h3>"+t+"年"+n+"月</h3>");var d,p,g,m=u.first,v=this.days;for(c.push('<ul class="c-clearfix">'),d=0,p=v.length;p>d;d++)g=d===o-1||m&&d===o-2||!m&&d===m?' class="'+l+'-weekend"':"",c.push("<li"+g+">"+v[d]+"</li>");c.push("</ul>"),c.push('<p class="c-clearfix">');var y,b,x,w,C=0,T=(o+r+1-i%o)%o;if(p=T-m,p>0){for(e.setDate(0),y=e.getFullYear(),b=e.getMonth()+1,x=e.getDate(),w=[y,h(b),""].join(s),g=l+"-pre-month",d=x-p+1;x>=d;d++)C%=o,e.setDate(d),c.push('<a href="#" hidefocus class="'+g+'" data-date="'+w+h(d)+'" data-week="'+C+'">'+d+" "+f(e,l)+"</a>"),C++;e.setDate(x+1)}for(e.setDate(1),e.setMonth(n),e.setDate(0),w=[t,h(n),""].join(s),d=1,p=e.getDate();p>=d;d++)C%=o,e.setDate(d),c.push('<a href="#" hidefocus  data-date="'+w+h(d)+'" data-week="'+C+'">'+d+" "+f(e,l)+"</a>"),C++;for(e.setDate(p+1),y=e.getFullYear(),b=e.getMonth()+1,w=[y,h(b),""].join(s),g=l+"-next-month",p=(p+Math.max(0,T-m))%7,p=p>0?7-p:0,d=1;p>=d;d++)C%=o,e.setDate(d),c.push('<a href="#" hidefocus class="'+g+'" data-date="'+w+h(d)+'" data-week="'+C+'">'+d+" "+f(e,l)+"</a>"),C++;return c.push("</p>"),k[a]=c.join(""),k[a]},onClick:function(e){var t=e;if(t){for(var n=e.target,i=n.tagName;"A"!==i&&n!==this.main;)n=n.parentNode,i=n.tagName;var r=d(n);switch(i){case"A":e.preventDefault();var a=this.options.prefix,o=a+"-pre",s=a+"-next",u=a+"-go-today",l=a+"-add-event",c=a+"-disabled";if(r.hasClass(o))N.showPreMonth.call(this),e.stopPropagation();else if(r.hasClass(s))N.showNextMonth.call(this),e.stopPropagation();else if(r.hasClass(u)){var f=new Date;if(N.getYYYYMM.call(this,this.date)!==N.getYYYYMM.call(this,f))this.date=f,N.build.call(this)}else if(r.hasClass(l))this.fire("add",this);else if(!r.hasClass(c))N.pick.call(this,n,t)}this.fire("click",e)}},showPreMonth:function(){var e=this.date;e.setDate(0),N.build.call(this,e)},showNextMonth:function(){var e=this.date;e.setDate(1),e.setMonth(e.getMonth()+1),N.build.call(this,e)},updateStatus:function(){var e=this.options,t=e.prefix,n=e.process,i=e.first,r=new Date,a=this.format(r,T),o=this.range,s="",u="9999-12-31";if(o)s=o.begin&&this.format(o.begin,T)||s,u=o.end&&this.format(o.end,T)||u;var l,c,f,h,d,p,g,m,v,y=t+"-pre-month",b=t+"-next-month",x=t+"-disabled",w=t+"-today",C=t+"-weekend",k=this.main.getElementsByTagName("p");for(l=0,c=k.length;c>l;l++)for(d=k[l].getElementsByTagName("a"),f=0;h=d[f];f++){if(p=[],g=h.getAttribute("data-date"),m=h.className,v=!0,o&&(s>g||g>u))p.push(x),v=!1;var N=f%7;if(6===N||i&&5===N||!i&&0===N)p.push(C);if(~m.indexOf(y))p.push(y);else if(~m.indexOf(b))p.push(b);else if(g===a)p.push(w);if(n)n.call(this,h,p,g,v);h.className=p.join(" ")}},pick:function(e,t){var n=e.getAttribute("data-week"),i=this.from(e.getAttribute("data-date"),T),r=this.format(i);this.fire("pick",{value:r,week:this.options.lang.week+this.days[n],date:i,event:t})}},S=g.extend({type:"Lunar",options:{main:"",prefix:"ecl-ui-lunar",dateFormat:"",range:{begin:"1900-01-01",end:"2100-12-31"},value:"",process:null,first:0,lang:{week:"周",days:"日,一,二,三,四,五,六"}},init:function(e){this.bindEvents(N),this.dateFormat=e.dateFormat||S.DATE_FORMAT||T,this.days=e.lang.days.split(","),this.date=this.from(e.value),this.value=this.format(this.date),this.setRange(e.range||S.RANGE)},from:function(e,t){if(t=t||this.dateFormat,p.isString(e)){if(!e)return new Date;t=t.split(/[^yMdW]+/i),e=e.split(/\D+/);for(var n={},i=0,r=t.length;r>i;i++)if(t[i]&&e[i]&&(t[i].length>1&&e[i].length===t[i].length||1===t[i].length))n[t[i].toLowerCase()]=e[i];var a=n.yyyy||n.y||(n.yy<50?"20":"19")+n.yy,o=0|(n.m||n.mm),s=0|(n.d||n.dd);return new Date(0|a,o-1,s)}return e},format:function(e,t){if(t=(t||this.dateFormat).toLowerCase(),p.isString(e))e=this.from(e);var n=this.options,i=n.first,r=e.getFullYear(),a=e.getMonth()+1,o=e.getDate(),s=e.getDay();if(i)s=(s-1+7)%7;s=this.days[s];var u={yyyy:r,yy:r%100,y:r,mm:h(a),m:a,dd:h(o),d:o,w:s,ww:n.lang.week+s};return t.replace(/y+|M+|d+|W+/gi,function(e){return u[e]||""})},render:function(){var e=this.options;if(!this.rendered){this.rendered=!0;var t=this.main=p.g(e.main),n=e.prefix,i=n+"-month";t.innerHTML='<div class="'+i+'"></div><a href="#" class="'+n+'-pre"></a><a href="#" class="'+n+'-next"></a><a href="#" class="'+n+'-go-today">今天</a><a href="#" class="'+n+'-add-event">添加事件</a>',this.monthElement=d("."+i,t).get(0),N.build.call(this),d(t).on("click",this._bound.onClick).addClass("c-clearfix")}return this},getDayElements:function(){return this.monthElement.getElementsByTagName("a")},getDaysInfo:function(){var e=this.getDayElements(),t={};return p.each(e,function(e,n){var i=e.getAttribute("data-date");t[i]={date:i,element:e,week:0|e.getAttribute("data-week"),index:n,rows:n/7|0,cols:n%7}}),t},setRange:function(e){if(e){var t=e.begin,n=e.end;if(t&&p.isString(t))e.begin=this.from(t);if(n&&p.isString(n))e.end=this.from(n);this.range=e,this.rendered&&N.updatePrevNextStatus.call(this)}},setValue:function(e){this.date=this.from(e),this.value=this.format(this.date),N.build.call(this)}});return S.DATE_FORMAT=T,S});