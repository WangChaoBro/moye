/*! 2015 Baidu Inc. All Rights Reserved */
define("ui/Select",["require","jquery","./lib","./Control","./Popup","./painter"],function(require){var t=require("jquery"),e=require("./lib"),n=require("./Control"),i=require("./Popup"),r=n.extend({type:"Select",options:{maxLength:16,ellipsis:"...",columns:1,selectedClass:"selected",datasource:[],valueUseIndex:!1,defaultLabel:"请选择",indicator:!0,adapter:{toOption:function(t){return t},toLabel:function(t){return t.name}}},init:function(e){this.$parent(e);var n=t(this.main);this.datasource=this.datasource||n.data("datasource")||[];var i=this.getOption(this.value||n.data("value"));this.value=i?i.value:null},getOption:function(t){for(var e=this.datasource,n=e.length-1;n>=0;n--){var i=this.adapter.toOption.call(this,e[n]);if(i.value===t)return i}return null},initStructure:function(){var e=["select"],n=+this.columns;if(n)e.push("select-columns"+n);var r=this.helper,a=this.popup=new i({main:r.createPart("popup"),target:this.main,triggers:[this.main],offset:this.offset,skin:e});a.on("click",t.proxy(this._onPopupClick,this)).on("show",t.proxy(this._onPopupShow,this)).on("hide",t.proxy(this._onPopupHide,this)).render(),r.addPartClasses("popup",a.main),this.addChild(a),this.main.innerHTML=""+r.getPartHTML("input","input","",{type:"hidden",value:this.value})+r.getPartHTML("label","a","",{href:"#"})},initEvents:function(){this.delegate(this.main,"click",this._onMainClicked)},repaint:require("./painter").createRepaint(n.prototype.repaint,{name:["datasource"],paint:function(t,n){if(!e.isArray(n))n=(n+"").split(/\s*[,]\s*/);for(var i=[],r=!!this.valueUseIndex,a=0;a<n.length;a++){var s=n[a];if(!e.isObject(s)){var o=s.split(/\s*[:]\s*/);s={text:o[0]},s.value=o.length>1?o[1]:r?a:o[0]}i.push('<a href="#" data-value="'+s.value+'" data-index="'+a+'">'+s.name+"</a>")}this.popup.main.innerHTML=i.join("")}},{name:["value"],paint:function(n,i){if(i)this.addState("selected");var r,a=this.helper,s=a.getPart("input"),o=this.datasource||[],l=a.getPartClassName("option-selected");if(i=this.isNumber?+i:i,e.each(t(this.popup.main).children(),function(e,n){var a=t(e),s=this.adapter.toOption.call(this,o[n]);if(s.value!==i)return void a.removeClass(l);if(s.value===i)s=o[n]||{index:n,name:a.html(),value:s.value},r=this.adapter.toLabel.call(this,s),a.addClass(l);else;},this),!r)r=this.defaultLabel,this.removeState("expanded"),s.value="";else s.value=i;a.getPart("label").innerHTML=r+this._getIndicatorHTML()}},{name:["defaultLabel"],paint:function(t,e){if(!this.hasState("selected"))this.helper.getPart("label").innerHTML=""+e+this._getIndicatorHTML()}}),_getIndicatorHTML:function(){var t=this.indicator;return e.isBoolean(t)&&t===!1?"":this.helper.getPartHTML("indicator","i",t===!0?"":t)},fill:function(t){this.set("datasource",t)},_pick:function(e){var n=t(e).data("value"),i=this.set("value",n);if(i)this.fire("change",{value:n})},getValue:function(t){var e=this.helper.getPart("input").value;return t?+e:e},setValue:function(t){return this.set("value",t),this},_onPopupClick:function(t){var e=t.target;if("A"===e.tagName)t.preventDefault(),this._pick(e),this.popup.hide(),this.removeState("expanded")},_onPopupShow:function(t){if(this.isDisabled())return void t.preventDefault();if(this.fire(t),!t.isDefaultPrevented())this.addState("expanded"),this.removeState("selected")},_onPopupHide:function(t){if(this.fire(t),!t.isDefaultPrevented())this.removeState("expanded"),this.getValue()&&this.addState("selected")},_onMainClicked:function(t){t.preventDefault()},dispose:function(){this.undelegate(this.main,"click",this._onMainClicked),this.$parent()}});return r});