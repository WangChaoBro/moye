/*! 2015 Baidu Inc. All Rights Reserved */
define("ui/Calendar",["require","jquery","./lib","./Control","./Popup","./painter"],function(require){var e=require("jquery"),t=require("./lib"),n=require("./Control"),r=require("./Popup"),i=t.pad,o="yyyy-MM-dd",a=null,s=n.extend({type:"Calendar",options:{dateFormat:o,range:a,process:null,months:1,weekStart:0,lang:{week:"周",days:"日,一,二,三,四,五,六",title:"{year}年{month}月"}},init:function(e){this.$parent(e);var t=this.main;if("INPUT"===t.tagName){var n=document.createElement("div"),r=t.parentNode;if(r)r.insertBefore(n,t);n.appendChild(t),this.main=n,this.input=t}var i=this.value||this.input&&this.input.value,o=this.date=this.from(i);this.days=this.lang.days.split(","),this.month=this._getMonthFirstDate(o),this.value=this.format(o)},_buildPagerHtml:function(e){var t=this.helper,n=t.getPartId(e),r=""+t.getPartClassName("pager")+" "+t.getPartClassName("pager-"+e);return'<a href="#" data-direction="'+e+'"class="'+r+'" id="'+n+'"></a>'},_getMonthFirstDate:function(e){var t=new Date(e);return t.setDate(1),t},_getMonthLastDate:function(e){var t=new Date(e);return t.setMonth(t.getMonth()+1),t.setDate(0),t},initStructure:function(){var t=this.main,n=this.input;if(!n)n=this.input=e("input",t)[0]||e('<input type="text">').appendTo(t).get(0);var i=this.helper,o=""+this._buildPagerHtml("pre")+this._buildPagerHtml("next")+i.getPartHTML("content","ol"),a=this.popup=new r({target:n,triggers:[n],content:o});a.render(),i.addPartClasses("popup",a.main),this.pre=i.getPart("pre"),this.next=i.getPart("next"),this.content=i.getPart("content")},initEvents:function(){var t=this.popup;t.on("click",e.proxy(this._onPopupClick,this)),t.on("hide",e.proxy(this._onPopupHide,this)),t.on("show",e.proxy(this._onPopupBeforeShow,this))},repaint:require("./painter").createRepaint(n.prototype.repaint,{name:["range","value"],paint:function(e,t,n){var r=this.date=this.from(n);if(t){var i=t.begin,o=t.end;if(i)i=t.begin=this.from(i);if(o)o=t.end=this.from(o);if(i>r||r>o)n=this.value=this.date="",this.month=this._getMonthFirstDate(i||o)}this.input.value=n}},{name:["months","month","range","value"],paint:function(e,t,n){var r=[];t=this.months=t||1,n=this._getMonthFirstDate(n||this.month),this._updatePrevNextStatus(n);for(var i=0;t>i;i++)r[i]=this._buildMonth(n),n.setMonth(n.getMonth()+1);this.content.innerHTML=r.join("")}}),from:function(e,n){if(!e)return new Date;if(t.isDate(e))return e;n=n||this.dateFormat,n=n.split(/[^yMdW]+/i),e=e.split(/\D+/);for(var r={},i=0,o=n.length;o>i;i++)if(n[i]&&e[i]&&(n[i].length>1&&e[i].length===n[i].length||1===n[i].length))r[n[i].toLowerCase()]=e[i];var a=r.yyyy||r.y||(r.yy<50?"20":"19")+r.yy,s=0|(r.m||r.mm),u=0|(r.d||r.dd);return new Date(0|a,s-1,u)},format:function(e,n){if(n=(n||this.dateFormat).toLowerCase(),t.isString(e))e=this.from(e);var r=this.weekStart,o=e.getFullYear(),a=e.getMonth()+1,s=e.getDate(),u=e.getDay();if(r)u=(u-1+7)%7;u=this.days[u];var l={yyyy:o,yy:o%100,y:o,mm:i(a),m:a,dd:i(s),d:s,w:u,ww:this.lang.week+u};return n.replace(/y+|M+|d+|W+/gi,function(e){return l[e]||""})},show:function(){this.popup.show()},hide:function(){this.popup.hide()},getValue:function(){var e=this.date;return e?this.format(e):""},getRawValue:function(){return this.date},setRange:function(e){this.range=null,this.set("range",e)},setValue:function(e){this.set("value",e)},_getYYYYMM:function(e){return t.isString(e)?e:this.format(this.from(e),"yyyyMM")},_buildMonth:function(e){var t=this.helper,n=['<li class="'+t.getPartClassName("month")+'">',this._buildMonthTitle(e),this._buildWeekTitle(),"<p>"],r=this._getMonthFirstDate(e),i=this._getMonthLastDate(e),o=r.getDay(),a=new Date(r);a.setDate(1-o);for(var s=0;42>s;s++){if(r>a)n.push(this._buildDate(a,"pre-month"));else if(a>i)n.push(this._buildDate(a,"next-month"));else n.push(this._buildDate(a));a.setDate(a.getDate()+1)}return n.push("</p></li>"),n.join("")},_buildMonthTitle:function(e){e={year:e.getFullYear(),month:e.getMonth()+1};var t=this.lang.title.replace(/\{([^\}]+)\}/g,function(t,n){return e[n]||""});return"<h3>"+t+"</h3>"},_buildWeekTitle:function(){for(var e=["<ul>"],t=this.helper.getPartClassName("weekend"),n=this.days,r=this.weekStart,i=0;7>i;i++){var o=(r+i)%7,a=0===i||6===i?t:"";e.push('<li class="'+a+'">'+n[o]+"</li>")}return e.push("</ul>"),e.join("")},_buildDate:function(t,n){var r=t.getDay(),i=this.format(t),o=this.helper,a=this.range,s=!!a&&(a.begin>t||a.end<t),u=this.value&&this.value===i,l=this.format(new Date),c=[];if(0===r||6===r)c.push(o.getPartClassName("weekend"));if(n)c.push(o.getPartClassName(n));if(s)c.push(o.getPartClassName("disabled"));if(u)c.push(o.getPartClassName("checked"));if(i===l)c.push(o.getPartClassName("today"));var f={classList:c,value:i,date:t,content:t.getDate()};if(this.process)f=this.process(f);return'<a href="#" class="'+e.trim(f.classList.join(" "))+'"data-week="'+f.date.getDay()+'" data-date="'+f.value+'">'+f.content+"</a>"},_page:function(e){var t=new Date(this.month),n="next"===e?1:-1;t.setMonth(t.getMonth()+n),t.setDate(1),this.set("month",t)},_updatePrevNextStatus:function(t){var n=this.range;if(n){var r=this._getYYYYMM(t);e(this.pre)[n.begin&&r<=this._getYYYYMM(n.begin)?"hide":"show"](),e(this.next)[n.end&&r>=this._getYYYYMM(n.end)?"hide":"show"]()}},_pick:function(t){t=e(t);var n=t.data("date");if(this.value===n)return void this.hide();var r=this.from(n,o);n=this.format(r);var i=new e.Event("change",{value:n});if(this.fire(i),!i.isDefaultPrevented())this.hide(),e(this.input).focus(),this.set("value",n)},_onPopupClick:function(t){var n=this.helper,r=e(t.target).closest("a",this.popup.main);if(r.is("a")){if(t.preventDefault(),r.hasClass(n.getPrimaryClassName("pager")))return void this._page(r.data("direction"));if(!r.hasClass(n.getPrimaryClassName("disabled")))this._pick(r)}},_onPopupBeforeShow:function(t){var n=new e.Event("show");if(this.fire(n),n.isDefaultPrevented())return void t.preventDefault();var r=this.date;if(r)this.set("month",this._getMonthFirstDate(r))},_onPopupHide:function(e){this.fire(e)},checkValidity:function(){return this.validate()},validate:function(){var e=this.target.value;if(e){var t=this.from(e);if(this.format(t)===e){var n=this.range,r="",i="9999-12-31";if(n)return r=n.begin&&this.format(n.begin,o)||r,i=n.end&&this.format(n.end,o)||i,e=this.format(t,o),e>=r&&i>=e;else return!0}}return!1},dispose:function(){this.popup.dispose(),this.popup=null}});return s.DATE_FORMAT=o,s.RANGE=a,s});