/*! 2015 Baidu Inc. All Rights Reserved */
define("ui/PicUploader",["require","jquery","./lib","./Control"],function(require){function e(e,t){var n=new FileReader(e);n.onload=function(e){t&&t(e.target.result),n=null},n.readAsDataURL(e)}function t(e){var t=document.createElement("input");t.type="file";for(var n in e)t[n]=e[n];return t}var n=require("jquery"),i=require("./lib"),r=require("./Control"),a="FileReader"in window,o={getClass:function(e){return e=e?"-"+e:"",this.options.prefix+e},getDom:function(e,t){return n("."+o.getClass.call(this,e),i.g(t))[0]},onCloseClick:function(e){var t=n(e.target),i="."+o.getClass.call(this,"picker"),r=t.closest(i)[0];o.removePicker.call(this,r)},onFileChange:function(r){var s=n(r.target),l=s.val();if(l){var u=Math.max(l.lastIndexOf("/"),l.lastIndexOf("\\")),c=l.slice(u+1);c=c.slice(0,c.lastIndexOf("."));var f="."+o.getClass.call(this,"picker"),h=s.closest(f),d=this._bound;if(!l.match(this.options.fileType)){if(i.browser.ie){var p=t({className:s.attr("class")});s.after(p).off("change",d.onFileChange).remove(),n(p).on("change",d.onFileChange)}else s.val("");h.addClass(o.getClass.call(this,"error")),this.fire("pickerror",{fileName:l})}else{var g=o.getDom.call(this,"pic",h.get(0));if(a)e(s.get(0).files[0],function(e){var t=document.createElement("IMG");t.src=e,g.appendChild(t),g=null});else g.innerHTML="<em>"+c+"</em>";if(o.getDom.call(this,"title",h.get(0)).innerHTML=c,h.attr("title",c).removeClass(o.getClass.call(this,"cur")).removeClass(o.getClass.call(this,"error")).addClass(o.getClass.call(this,"picked")),s.off("change",d.onFileChange),this.count++,this.count<this.options.maxCount)o.create.call(this);this.fire("pick",{fileName:l})}}},removePicker:function(e){var t=o.getDom.call(this,"file",e).value,i=this._bound;if(n(o.getDom.call(this,"file",e)).off("change",i.onFileChange),n(o.getDom.call(this,"close",e)).off("click",i.onCloseClick),e.parentNode.removeChild(e),this.count--,this.count===this.options.maxCount-1)o.create.call(this);this.fire("remove",{fileName:t})},bindPicker:function(e){var t=this._bound;n(o.getDom.call(this,"file",e)).on("change",t.onFileChange),n(o.getDom.call(this,"close",e)).on("click",t.onCloseClick)},create:function(){var e={closeClass:o.getClass.call(this,"close"),picClass:o.getClass.call(this,"pic"),titleClass:o.getClass.call(this,"title"),fileClass:o.getClass.call(this,"file"),wrapperClass:o.getClass.call(this,"wrapper")},t=this.createElement("div",{className:o.getClass.call(this,"picker")+" "+o.getClass.call(this,"cur")});t.innerHTML=this.options.tpl.replace(/#\{([\w-.]+)\}/g,function(t,n){return e[n]||""}),this.options.main.appendChild(t),o.bindPicker.call(this,this.curPicker=t)}},s=r.extend({type:"PicUploader",options:{main:"",prefix:"ecl-ui-picuploader",maxCount:3,fileType:/\.(jpg|png|gif|jpeg)$/,tpl:'<div class="#{closeClass}" title="关闭">×</div><div class="#{picClass}"></div><div class="#{titleClass}">点击上传</div><a href="javascript:;" class="#{wrapperClass}"><input type="file" class="#{fileClass}"></a>'},count:0,init:function(e){if(!e.main&&1!==e.main.nodeType)throw new Error("invalid main");if(this.bindEvents(o),this._disabled=e.disabled,this._disabled)this.disable()},render:function(){if(!this.rendered)o.create.call(this),this.rendered=!0;return this},remove:function(e,t){var i=this;return t=t||function(e,t,n){return e===t},n("."+o.getClass.call(this,"file"),this.main).each(function(r,a){if(a.value===e&&t(a.value,e,r))o.removePicker.call(i,n(a).closest("."+o.getClass.call(i,"picker")).get(0))}),this},removeAt:function(e){var t=n("."+o.getClass.call(this,"picker"),this.options.main);if(t[e]!==this.curPicker)o.removePicker.call(this,t[e]);return this},getFileList:function(){var e=this;return n("."+o.getClass.call(this,"file"),this.options.main).map(function(t,n){return n.value.match(e.options.fileType)?n.value:null}).get()},enable:function(){if(this.curPicker)n(this.options.main).removeClass(o.getClass.call(this,"disabled"));return this._disabled=0,this},disable:function(){if(this.curPicker)n(this.options.main).addClass(o.getClass.call(this,"disabled"));return this._disabled=1,this},dispose:function(){if(this.curPicker){var e=this._bound;n(o.getDom.call(this,"file",this.curPicker)).off("change",e.onFileChange),n(o.getDom.call(this,"close",this.curPicker)).off("click",e.onCloseClick),this.curPicker=0}this.options.main.innerHTML="",this.parent("dispose")}});return s});